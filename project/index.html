<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Firearm Panic Buying, 2020</title>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin="" />
	<!-- Goldman Font -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
	<!-- Hind Siliguri Font -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Goldman&family=Hind+Siliguri:wght@300&display=swap" rel="stylesheet">

	<style>
		body {
			background: #20282e;
			font-family: 'Open Sans', sans-serif;
			font-weight: 400;
		}

		h1 {
			font-weight: 800;
			font-family:'Goldman';
		}

		h3 {
			font-weight: 200;
			font-family: 'Hind Siliguri';
		}

		p {
			line-height: 1.7rem;
		}

		a {
			color: #f0ad4e;
		}

		#map {
			height: 80vh;
			background: #20282e;
		}

		#legend {
			font-size: 1rem;
			border-radius: 5px;
			max-width: 200px;
			font-family: 'Open Sans', sans-serif;
		}

		#legend span {
			width: 20px;
			height: 20px;
			float: left;
			margin: 0 10px 4px 0;
		}

		#legend label {
			font-size: 0.9rem;
		}

		#legend label:after {
			content: '';
			display: block;
			clear: both;
		}

		/* Small devices (landscape phones, 576px and up) */
		@media (min-width: 576px) {}

		/* Medium devices (tablets, 768px and up) */
		@media (min-width: 768px) {

			aside {
				height: 80vh;
			}
		}

		/* Large devices (desktops, 992px and up) */
		@media (min-width: 992px) {}

		/* Extra large devices (large desktops, 1200px and up) */
		@media (min-width: 1200px) {}
	</style>

</head>

<body>
	<div class="container-fluid">
		<header class="row bg-dark text-warning py-3">
			<div class="col">
				<h1>Panic Buying Firearms in 2020, U.S.</h1>
			</div>
		</header>

		<section class="row">
			<div class="col-md-8 col-lg-9 col-xl-10 order-md-2 px-0">
				<div id="map"></div>
			</div>
			<aside id="about"
				class="col-md-4 col-lg-3 col-xl-2 order-md-1 text-white py-2 pl-3 bg-secondary overflow-auto">
				<section>
					<h3 class="py-2 text-warning">Response to Civil Unrest</h3>
					<p>The main focus of this map is to emphasize the surge of firearms purchased in 2020. The spread of 
						COVID-19 and the pending presidential election only exacerbated what can be described as firearm
						panic buying. To aid in emphasizing the magnitude of firearm purchases this year, NICS firearm data
						going back to 2008 helps give the 2020 some depth and reference. Regardless of your views on the 2nd Amendment and firearms, I wish to point out that
						in times of civil unrest, everyone's priority is protecting themselves and their loved ones by any means
						necessary. This takes priority over political beliefs. 
						<br><br>
					<h3 class="py-2 text-warning">First-time Owners</h3>
					<p>A large reason why 2020 has been a pivotal year in firearm and ammunition sales,
						is new firearm owners. The NSSF (National Shooting Sports Foundation) shared a retail-based 
						survey article breaking down this year's record setting numbers. 
						The <a target="_blank" href="https://www.nssf.org/first-time-gun-buyers-grow-to-nearly-5-million-in-2020/">NSSF</a> 
						survey estimates about 40% of all firearm purchases this year are thanks to those who never previously owned a firearm. 
						12.1 million firearms purchased between January and July of 2020 is a new record; approximately 
						a 71.1% increase compared to those months last year. There are many other amazing statistics, so if you are curious,
						click the NSSF link!
					</p>
					<h3 class="py-2 text-warning">Notice</h3>
						All data presented was documented by the FBI via the NICS 
						(National Instant Criminal Background Check System), ergo <span style="color: #f0ad4e">LEGALLY</span> obtained firearms.
					</p>

					<p>
					</p>
				</section>
			</aside>
		</section>

		<footer class="row bg-dark text-white py-3">
			<div class="col">
				<ul class="list-unstyled">
					<li>Authored by <a href="https://math264.github.io/">Michael A. Thomas</a> @ NEWMAPSPLUS</li>
					<li>December 23, 2020</li>
		<li>data source: <a target="_blank" href="https://data.world/buzzfeednews/nics-background-check-counts">FBI NICS</a></li>
				</ul>
			</div>
		</footer>
	</div>

	<!-- legend is outside of container-fluid and will be dynamically added to map -->
	<div class="bg-secondary py-2 px-3 ml-3 mt-3 text-white" id="legend"></div>

	<!-- ui is outside of container-fluid and will be dynamically added to map -->
	<div class="form-group mr-3 mt-3" id="dropdown-ui">
		<select class="form-control bg-primary text-white">
			<option value="OWNED_MORT" selected>owned with mortgage</option>
			<option value="OWNED_FREE">owned free and clear</option>
			<option value="RENTER">rented</option>
		</select>
	</div>

	<!-- jQuery first and the minified version from jQuery site, not the slim minified version from Bootstrap's site. -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<!-- then Popper JS -->
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
		integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
		crossorigin="anonymous"></script>
	<!-- then Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
		integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
		crossorigin="anonymous"></script>
	<!-- then Leaflet JS -->
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
	<!-- then Simple Statistics -->
	<script src='https://unpkg.com/simple-statistics@7.3.0/dist/simple-statistics.min.js'></script>

	<!-- CUSTOM JS CODE -->
	<script>
		// initial Leaflet map options
		const options = {
			zoomSnap: .1,
			// center: [40, -90],
			// zoom: 4
			zoomControl: false
		}

		// create Leaflet map and apply options
		const map = L.map('map', options);
		// Adding new Zoom Control button to right side
		new L.control.zoom({ position: "bottomright" }).addTo(map)
		// request a basemap tile layer and add to the map
		L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map)

		// AJAX REQUEST for GeoJSON data
		$.getJSON("/data/firearm_sales_2008_2020.geojson", function (data) {
			// jQuery method uses AJAX request for the GeoJSON data
			drawMap(data);
		});

		// // Creating breaks and colors
		// function processData(counties, csv) {

		// }

	function drawMap(data) {
      const firearms = L.geoJson(data, {
        // style counties with initial default path options
        style: function (feature) {
          return {
            color: '#20282e',
            weight: 1,
            fillOpacity: 1,
            fillColor: '#1f78b4'
          };
        },
        // add hover/touch functionality to each feature layer
        onEachFeature: function (feature, layer) {

          // when mousing over a layer
          layer.on('mouseover', function () {

            // change the stroke color and bring that element to the front
            layer.setStyle({
              color: '#ff6e00'
            }).bringToFront();
          });

          // on mousing off layer
          layer.on('mouseout', function () {

            // reset the layer style to its original stroke color
            layer.setStyle({
              color: '#20282e'
            });
          });
        }
      }).addTo(map);
      // fit the map's bounds and zoom level using the counties extent
      // map.fitBounds(countiesLayer.getBounds(), {
      //   padding: [18, 18] // add padding around counties
      // });
    	//  calling createSliderUI
      createSliderUI(firearms);
    	// calling updateMap function
      updateMap(firearms);

	function updateMap(firearms) {
      // loop through each county layer to update the color and tooltip info
      counties.eachLayer(function (layer) {

        const props = layer.feature.properties;
        // console.log(props.unemploymentData[currentYear])
        // set the fill color of layer based on its normalized data value
        // build tooltip
        let tooltipInfo = ''
        if (props.unemploymentData != undefined) {
          layer.setStyle({
            fillColor: colorize(Number(props.unemploymentData[currentYear]))
          });
          tooltipInfo = `<b>${props.unemploymentData["NAME"]} County</b></br>
              ${props.unemploymentData[currentYear]}% Unemployment`;

        } else {
          tooltipInfo = 'No data'
          layer.setStyle({
            fillColor: 'lightgray'
          });
        }
        // bind a tooltip to layer with county-specific information
        layer.bindTooltip(tooltipInfo, {
          // sticky property so tooltip follows the mouse
          sticky: true
        });
        
      });
    }

    function drawLegend(breaks, colorize) {
      // create a Leaflet control for the legend
      const legendControl = L.control({
        position: 'topright'
      });

      // when the control is added to the map
      legendControl.onAdd = function (map) {

        // create a new division element with class of 'legend' and return
        const legend = L.DomUtil.create('div', 'legend');
        return legend;

      };

      // add the legend control to the map
      legendControl.addTo(map);

      // select div and create legend title
      const legend = $('.legend').html("<h3><span>2001</span> Unemployment Rates</h3><ul>");

        // What color is returned when the value is outside of the breaks?  
      console.log(colorize('What color is returned?'))

      // loop through the break values
      for (let i = 0; i < breaks.length - 1; i++) {

        // determine color value 
        const color = colorize(breaks[i], breaks);

        // create legend item
        const classRange = `<li><span style="background:${color}"></span>
        ${breaks[i].toFixed(2)} &mdash;
        ${breaks[i + 1].toFixed(2)}% </li>`

        // append to legend unordered list item
        $('.legend ul').append(classRange);
      }
      // Add legend item for missing data
			$('.legend ul').append(`<li><span style="background:lightgray"></span>
                              Data not available</li>`)
      // close legend unordered list
      legend.append("</ul>");

    } // end drawLegend()

    function createSliderUI(countiesLayer, colorize) {
      // create Leaflet control for the slider
      const sliderControl = L.control({ position: 'bottomleft' });

      // when added to the map
      sliderControl.onAdd = function (map) {

        // select an existing DOM element with an id of "ui-controls"
        const slider = L.DomUtil.get("ui-controls");

        // disable scrolling of map while using controls
        L.DomEvent.disableScrollPropagation(slider);

        // disable click events while using controls
        L.DomEvent.disableClickPropagation(slider);

        // return the slider from the onAdd method
        return slider;
      }

      // add the control to the map
      sliderControl.addTo(map);

      // select the form element
      $(".year-slider")
        .on("input change", function () { // when user changes
          const currentYear = this.value; // update the year
          $('.legend h3 span').html(currentYear); // update the map with current timestamp
          updateMap(countiesLayer, colorize, currentYear); // update timestamp in legend heading
        });
    } // end createSliderUI()
    }


	
		
	</script>
</body>

</html>