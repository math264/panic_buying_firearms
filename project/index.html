<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Firearm Panic Buying, 2020</title>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin="" />
	 <!-- Loading Chroma.js -->
	 <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
	<!-- Goldman Font -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
	<!-- Hind Siliguri Font -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Goldman&family=Hind+Siliguri:wght@300&display=swap" rel="stylesheet">

	<style>
		/* ELEMENTS | IDs | CLASSES */
		body {
			background: #20282e;
			font-family: 'Open Sans', sans-serif;
			font-weight: 400;
		}

		h1 {
			font-weight: 800;
			font-family:'Goldman';
		}

		h3 {
			font-weight: 200;
			font-family: 'Hind Siliguri';
		}

		p {
			line-height: 1.7rem;
		}

		a {
			color: #f0ad4e;
		}

		#map {
		position: absolute;
		width: 100%;
		top: 0;
		bottom: 0;
		}

		.legend {
		padding: 6px 8px;
		font-size: 1em;
		background: rgba(75, 75, 75, 0.8);
		color: #f0ad4e;
		box-shadow: 0 0 15px #f0ad4e;
		border-radius: 5px;
		width: 160px;
		}

		.legend h3 {
		font-size: 1.1em;
		font-weight: bold;
		line-height: 1em;
		color: whitesmoke;
		margin: 0;
		}

		.legend h3 span {
		font-size: 1.3em;
		margin: 0 20px 0 0;
		}

		.legend ul {
		list-style-type: none;
		padding: 0;
		margin: 12px 4px 0;
		}

		.legend li {
		height: 22px;
		}

		.legend span {
		width: 30px;
		height: 20px;
		float: left;
		margin-right: 10px;
		}

		.picture {
		width: 30px;
		height: 20px;
		float: left;
		margin-right: 10px;
		}
		

		#ui-controls {
		width: 176px;
		padding: 8px 25px 8px 15px;
		background: rgba(75, 75, 75, 0.8);
		box-shadow: 0 0 15px #f0ad4e;
		border-radius: 5px;
		color: #f0ad4e;
		}

		#ui-controls .min {
		float: left;
		}

		#ui-controls .max {
		float: right;
		margin-right: -15px;
		}

		.year-slider {
		width: 100%;
		}

		label {
		font-size: 1.1em;
		font-weight: bold;
		}

		footer {
		padding: 6px;
		width: 80%;
		}

	/* MOBILE-FRIENDLY SETTINGS */
		/* Small devices (landscape phones, 576px and up) */
		@media (min-width: 576px) {}
		/* Medium devices (tablets, 768px and up) */
		@media (min-width: 768px) {
			aside {
				height: 80vh;
			}
		}
		/* Large devices (desktops, 992px and up) */
		@media (min-width: 992px) {}
		/* Extra large devices (large desktops, 1200px and up) */
		@media (min-width: 1200px) {}
	</style>

</head>

<!--  BODY -->
<body>
	<div class="container-fluid">
		<header class="row bg-dark text-warning py-3" 
		style="background-image: 
		url('https://cdn.hipwallpaper.com/i/14/15/f4VKHu.jpg'); background-repeat: no-repeat; background-size: cover;">
			<div class="col">
				<h1>Panic Buying Firearms in 2020, U.S.</h1>
			</div>
			<div class="bg-image"></div>
		</header>

		<section class="row">
			<div class="col-md-8 col-lg-9 col-xl-10 order-md-2 px-0">
				<div id="map"></div>
				<div id="ui-controls">
					<label>
					  <span class="min">1</span>
					  <span class="max">154</span>
					  <input type="range" min="1" , max="154" , value="1" , step="1" , class="year-slider">
					</label>
				  </div>
				  <div class="picture">
					
				  </div>
			</div>
			<aside id="about"
				class="col-md-4 col-lg-3 col-xl-2 order-md-1 text-white py-2 pl-3 bg-secondary overflow-auto">
				<section>
					<h3 class="py-2 text-warning">Response to Civil Unrest</h3>
					<p>The main focus of this map is to emphasize the surge of firearms purchased in 2020. The spread of 
						COVID-19 and the pending presidential election only exacerbated what can be described as firearm
						panic buying. To aid in emphasizing the magnitude of firearm purchases this year, NICS firearm data
						going back to 2008 is provided to give 2020 sales some depth and reference. Regardless of views on the 2nd Amendment and firearms, 
						I wish to point out that in times of civil unrest, everyone's priority is protecting themselves and their loved ones by any means
						necessary. This naturally takes priority over political beliefs. 
						<br><br>
					<h3 class="py-2 text-warning">First-time Owners</h3>
					<p>A large reason why 2020 has been a pivotal year in firearm and ammunition sales,
						is new firearm owners. The NSSF (National Shooting Sports Foundation) shared a retail-based 
						survey article breaking down this year's record setting numbers. 
						The <a target="_blank" href="https://www.nssf.org/first-time-gun-buyers-grow-to-nearly-5-million-in-2020/">NSSF</a> 
						survey estimates about 40% of all firearm purchases this year are thanks to those who never previously owned a firearm. 
						12.1 million firearms purchased between January and July of 2020 is a new record; approximately 
						a 71.1% increase compared to those months last year. There are many other amazing statistics, so if you are curious,
						click the NSSF link!
					</p>
					<h3 class="py-2 text-warning">Notice</h3>
						All data presented was documented by the FBI via the NICS 
						(National Instant Criminal Background Check System), ergo <span style="color: #f0ad4e">LEGALLY</span> obtained firearms.
					</p>

					<p>
					</p>
				</section>
			</aside>
		</section>

		<footer class="row bg-dark text-white">
			<div class="col">
				<ul class="list-unstyled">
					<li>Authored by <a href="https://math264.github.io/">Michael A. Thomas</a> @ NEWMAPSPLUS</li>
					<li>December 23, 2020</li>
					<li>data source: <a target="_blank" href="https://data.world/buzzfeednews/nics-background-check-counts">FBI NICS</a></li>
				</ul>
			</div>
			<hr>
			<div class="col">
			<a href="https://newmapsplus.github.io">
				<img src="https://newmapsplus.github.io/assets/graphics/logo-2018-nmp-75px-h-gray.png"
					alt="University of Kentucky Geography">
			</a>
	
			<a href="https://uky-gis.github.io">
				<img src="https://newmapsplus.github.io/assets/graphics/logo-2018-geography-75px-h.png"
					alt="University of Kentucky Geography">
			</a>
			</div>
		</footer>
	</div>

	<!-- JQUERY -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
	integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<!-- LEAFLET -->
  	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>


	<!-- CUSTOM JS CODE -->
	<script>
		// map options
		const options = {
      // scrollWheelZoom: false,
      // zoomSnap: .1,
      // dragging: false,
      // zoomControl: false
      center: [40, -100],
      zoom: 4
    }

    // CREATE LEAFLET MAP
    const map = L.map('map', options);

    // TILELAYER REQUEST
    const tiles = L.tileLayer('http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.{ext}', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      subdomains: 'abcd',
      ext: 'png'
    }).addTo(map);

    // AJAX REQUEST for GeoJSON data
    const firearmData = $.getJSON("/data/firearm_sales_2008_2020.geojson", function (state) {
        console.log(state)
        const total = [];
    
    // iterate through all the STATE FEATURES
    state.features.forEach(function (state) {

    // iterate through all the props of each STATE
      for (const prop in state.properties) {
        
    // if the attribute contains the string TOTAL -> total firearm sales
        if (prop.includes("firearm_sales_total")) {
          console.log(prop) // it's working

      // push TOTAL attribute values into the array
      total.push(Number(state.properties[prop]));
    }
      }
});

    // verify the result!
    // console.log('after: ', state);

      // create class breaks
      var breaks = chroma.limits(total, 'q', 5);

      // create color generator function
      var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');
      // console.log(colorize) // function (a){var b;return b=s(u(a)),m&&b[m]?b[m]():b}
      var color = colorize(20);
      // console.log(color); // a {_rgb: Array[4]}

      // Calling DRAWMAP Function with GeoJSON and Colorize Function
      drawMap(state, colorize);
      drawLegend(breaks, colorize);
    });
    // END OF AJAX REQUEST

	function drawMap(state, colorize) {
      const stateLayer = L.geoJson(state, {
        // style counties with initial default path options
        style: function (feature) {
          return {
            color: '#20282e',
            weight: 1,
            fillOpacity: 1,
            fillColor: '#1f78b4'
          };
        },
        // add hover/touch functionality to each feature layer
        onEachFeature: function (feature, layer) {

          // when mousing over a layer
          layer.on('mouseover', function () {

            // change the stroke color and bring that element to the front
            layer.setStyle({
              color: '#ff6e00'
            }).bringToFront();
          });

          // on mousing off layer
          layer.on('mouseout', function () {

            // reset the layer style to its original stroke color
            layer.setStyle({
              color: '#20282e'
            });
          });
        }
      }).addTo(map);
      // fit the map's bounds and zoom level using the counties extent
      // map.fitBounds(countiesLayer.getBounds(), {
      //   padding: [18, 18] // add padding around counties
      // });
      //  calling createSliderUI
      createSliderUI(stateLayer, colorize);
      // calling updateMap function
      updateMap(stateLayer, colorize, '2008_01');
    }

    function updateMap(state, colorize, date) {
      // loop through each county layer to update the color and tooltip info
      state.eachLayer(function (layer) {

        const props = layer.feature.properties;
        // console.log(props.unemploymentData[currentYear])
        // set the fill color of layer based on its normalized data value
        // build tooltip
        let tooltipInfo = ''
        let currentDate = `firearm_sales_total_${date}`
        // console.log(props)
        if (props != undefined) {
          layer.setStyle({
            fillColor: colorize(Number(props[currentDate]))
          });
          // tooltipInfo = `<b>${props.unemploymentData["NAME"]} County</b></br>
          //     ${props.unemploymentData[currentYear]}% Unemployment`;

        } else {
          tooltipInfo = 'No data'
          layer.setStyle({
            fillColor: 'lightgray'
          });
        }
        // bind a tooltip to layer with county-specific information
        layer.bindTooltip(tooltipInfo, {
          // sticky property so tooltip follows the mouse
          sticky: true
        });
        
      });
    }

    function drawLegend(breaks, colorize) {
      // create a Leaflet control for the legend
      const legendControl = L.control({
        position: 'topright'
      });

      // when the control is added to the map
      legendControl.onAdd = function (map) {

        // create a new division element with class of 'legend' and return
        const legend = L.DomUtil.create('div', 'legend');
        return legend;

      };

      // add the legend control to the map
      legendControl.addTo(map);

      // select div and create legend title
      const legend = $('.legend').html("<h3><span>2001</span> Unemployment Rates</h3><ul>");

        // What color is returned when the value is outside of the breaks?  
      console.log(colorize('What color is returned?'))

      // loop through the break values
      for (let i = 0; i < breaks.length - 1; i++) {

        // determine color value 
        const color = colorize(breaks[i], breaks);

        // create legend item
        const classRange = `<li><span style="background:${color}"></span>
        ${breaks[i].toFixed(2)} &mdash;
        ${breaks[i + 1].toFixed(2)}% </li>`

        // append to legend unordered list item
        $('.legend ul').append(classRange);
      }
      // Add legend item for missing data
			$('.legend ul').append(`<li><span style="background:lightgray"></span>
                              Data not available</li>`)
      // close legend unordered list
      legend.append("</ul>");

    } // end drawLegend()

    function createSliderUI(stateLayer, colorize) {
      // create Leaflet control for the slider
      const sliderControl = L.control({ position: 'bottomleft' });

      // when added to the map
      sliderControl.onAdd = function (map) {

        // select an existing DOM element with an id of "ui-controls"
        const slider = L.DomUtil.get("ui-controls");

        // disable scrolling of map while using controls
        L.DomEvent.disableScrollPropagation(slider);

        // disable click events while using controls
        L.DomEvent.disableClickPropagation(slider);

        // return the slider from the onAdd method
        return slider;
      }

      // add the control to the map
      sliderControl.addTo(map);

      // select the form element
      $(".year-slider")
        .on("input change", function () { // when user changes
		  //const currentYear = this.value; // update the year
		  const slider = this.value; // update the year
          const yearMonth = calculateYearMonth(slider)
		  $('.legend h3 span').html(yearMonth); // update the map with current timestamp
		//   if ${".year-slider"} = this.value
		//   let date = ${year}_${month}
		// Then maybe create two variables, year and month?
          updateMap(stateLayer, colorize, yearMonth); // update timestamp in legend heading
        });
	} // end createSliderUI()
	

    function calculateYearMonth(slider) {
	  // Create some empty variables
      let year = ''
      let month = ''
      const x = slider/12 // divide by twelve
      const y = slider%12 // find the remainder of a division by 12

	  // Modify for all years
      if (x <= 0) {
        year = '2008'
      } else if (x <= 1) {
        year = '2009'
      } else if (x <= 2) {
        year = '2010'
      } else if (x <= 3) {
        year = '2011'
      } else if (x <= 4) {
        year = '2012'
      } else if (x <= 5) {
        year = '2013'
      } else if (x <= 6) {
        year = '2014'
      } else if (x <= 7) {
        year = '2015'
      } else if (x <= 8) {
        year = '2016'
      } else if (x <= 9) {
        year = '2017'
      } else if (x <= 10) {
        year = '2018'
      } else if (x <= 11) {
        year = '2019'
      } else (x <= 12) 
        year = '2020'
	  

	  // Modify to include 12, i.e., if remainder is 0...
      if (y < 10) { 
        month = `0${y}`
      } else {
        month = `${y}`
      }
	  
	 console.log(`${year}_${month}`) 
      return `${year}_${month}`

    }
	</script>
</body>

</html>